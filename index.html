<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vocabulary Builder App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script defer src="week-data/week1.js"></script>
</head>
<body>
  <h1>Vocabulary Builder</h1>

  <div class="controls" style="max-width:860px;margin:0 auto 1rem;">
    <label>Week:
      <select id="weekSelect"></select>
    </label>
    <label style="margin-left:1rem;">Day:
      <select id="daySelect"></select>
    </label>
    <button id="loadWeekBtn">Load</button>

    <span style="float:right;">
      <strong>üîÅ Due Today:</strong> <span id="dueCount">0</span>
    </span>
  </div>

  <div class="tabs">
    <button data-tab="visual">üì∑ Visual Wall</button>
    <button data-tab="mnemonics">üß† Mnemonics</button>
    <button data-tab="context">‚úçÔ∏è Context Sentences</button>
    <button data-tab="quiz">üìù Quiz</button>
    <button data-tab="story">üß© Story Builder</button>
    <button data-tab="review">üîÅ Spaced Recall</button>
  </div>

  <div id="tab-content"></div>

  <hr style="margin:2rem 0;">

  <h3>üì• Load Vocabulary Data</h3>
  <p style="max-width:860px;margin:0 auto 1rem;">
    <strong>Option 1:</strong> Auto-load 5,000+ words with mnemonics from our curated dataset<br>
    <strong>Option 2:</strong> Upload your own <code>.csv</code> or <code>.json</code> file
  </p>
  
  <div style="max-width:860px;margin:0 auto 1rem;">
    <button id="autoLoadBtn" style="background-color:#27ae60;color:white;padding:10px 20px;margin-right:10px;border:none;border-radius:5px;cursor:pointer;">
      üìä Auto-Load Enhanced Dataset (5,000+ words)
    </button>
    <button id="manualLoadToggle" style="background-color:#3498db;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;">
      üìÅ Upload Custom File
    </button>
  </div>

  <div id="manualUpload" style="max-width:860px;margin:0 auto 1rem;display:none;">
    <p style="color:#666;margin-bottom:10px;">
      Upload a <code>.csv</code> or <code>.json</code> with columns: <code>word,definition,partOfSpeech,mnemonic,sentence,icon</code>
    </p>
    <input type="file" id="bulkFile" accept=".csv,.json" />
    <button id="ingestBtn">Ingest to Local Library</button>
  </div>
  
  <button id="resetBtn" style="background-color:#e74c3c;color:white;margin-left:10px;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;">üóëÔ∏è Reset All Data</button>
  <p id="ingestStatus"></p>

  <!-- scripts -->
  <script src="data_loader.js"></script>
  <script src="scheduler.js"></script>
  <script src="app.js"></script>
  <script>
    // Helper function from app.js
    function W() {
      if (Array.isArray(window.wordList)) {
        console.log('Using window.wordList:', window.wordList.length, 'words');
        return window.wordList;
      }
      try { 
        if (typeof wordList !== 'undefined') {
          console.log('Using seed wordList:', wordList.length, 'words');
          return wordList; 
        } 
      } catch(e){}
      console.log('No words found, returning empty array');
      return [];
    }

    function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }
    function escapeJS(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
    function cssEscape(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g, '_'); }

    // Toggle synonyms function
    function toggleSynonyms(index) {
      const synonymsSection = document.getElementById(`synonyms-${index}`);
      const expandIcon = document.getElementById(`expand-${index}`);
      
      if (synonymsSection.style.display === 'none' || synonymsSection.style.display === '') {
        synonymsSection.style.display = 'block';
        expandIcon.textContent = '‚ñ≤ hide synonyms';
        expandIcon.style.color = '#e74c3c';
      } else {
        synonymsSection.style.display = 'none';
        expandIcon.textContent = '‚ñº synonyms';
        expandIcon.style.color = '#3498db';
      }
    }

    // Render functions
    function renderVisualWall() {
      const list = W();
      if (!list.length) return `<p>No words loaded yet. Use the Week/Day picker and press <strong>Load</strong>.</p>`;
      return list.map((word, index) => {
        const hasSynonyms = word.synonyms || word.moreSynonyms;
        const synonymsDisplay = word.synonyms ? `<strong>Synonyms:</strong> ${word.synonyms}` : '';
        const moreSynonymsDisplay = word.moreSynonyms ? `<strong>More synonyms:</strong> ${word.moreSynonyms}` : '';
        
        return `<div class="word-card" style="margin-bottom:1.2em;padding:1em;background-color:#fafafa;border-radius:8px;border-left:4px solid #3498db;transition:all 0.3s ease;">
          <div class="word-header" style="display:flex;align-items:center;cursor:${hasSynonyms ? 'pointer' : 'default'};" ${hasSynonyms ? `onclick="toggleSynonyms(${index})"` : ''}>
            <img src="${word.icon || 'icons/book.png'}" alt="" style="height:40px;margin-right:12px;border-radius:4px;">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:0.5rem;">
                <strong style="font-size:1.1em;color:#2c3e50;">${word.word}</strong>
                ${word.partOfSpeech ? `<span style="color:#7f8c8d;font-size:0.9em;font-style:italic;">(${word.partOfSpeech})</span>` : ''}
                ${hasSynonyms ? `<span class="expand-icon" id="expand-${index}" style="color:#3498db;font-size:0.8em;margin-left:auto;">‚ñº synonyms</span>` : ''}
              </div>
              <div style="color:#34495e;margin-top:0.3em;">${word.definition}</div>
              ${word.category ? `<span style="color:#888;font-size:0.9em;">${word.category}</span>` : ''}
            </div>
          </div>
          ${hasSynonyms ? `
            <div class="synonyms-section" id="synonyms-${index}" style="display:none;margin-top:0.8em;padding-top:0.8em;border-top:1px solid #ecf0f1;">
              ${synonymsDisplay ? `<div style="margin-bottom:0.5em;color:#e67e22;">${synonymsDisplay}</div>` : ''}
              ${moreSynonymsDisplay ? `<div style="color:#8e44ad;">${moreSynonymsDisplay}</div>` : ''}
            </div>` : ''}
        </div>`;
      }).join('');
    }

    function renderMnemonics() {
      const list = W();
      if (!list.length) return `<p>No words loaded yet. Use the Week/Day picker and press <strong>Load</strong>.</p>`;
      return list.map(word =>
        `<div style="margin-bottom:1.5em;padding:1em;background-color:#f9f9f9;border-radius:8px;border-left:4px solid #3498db;">
          <strong style="color:#2c3e50;font-size:1.1em;">${word.word}</strong>
          <span style="color:#7f8c8d;margin-left:0.5em;">(${word.partOfSpeech || 'unknown'})</span>
          <div style="margin-top:0.5em;color:#34495e;">
            <strong>Definition:</strong> ${word.definition}
          </div>
          <div style="margin-top:0.8em;color:#e74c3c;">
            <strong>üß† Memory Device:</strong> ${word.mnemonic || '<em>No mnemonic available</em>'}
          </div>
          ${word.mnemonicSourceUrl ? `<div style="margin-top:0.3em;font-size:0.9em;"><a href="${word.mnemonicSourceUrl}" target="_blank" style="color:#3498db;">üìñ Source</a></div>` : ''}
        </div>`
      ).join('');
    }

    function renderContextSentences() {
      const list = W();
      if (!list.length) return `<p>No words loaded yet. Use the Week/Day picker and press <strong>Load</strong>.</p>`;
      return list.map(word =>
        `<div style="margin-bottom:1.5em;padding:1em;background-color:#f8fff8;border-radius:8px;border-left:4px solid #27ae60;">
          <strong style="color:#2c3e50;font-size:1.1em;">${word.word}</strong>
          <span style="color:#7f8c8d;margin-left:0.5em;">(${word.partOfSpeech || 'unknown'})</span>
          <div style="margin-top:0.5em;color:#34495e;">
            <strong>Definition:</strong> ${word.definition}
          </div>
          <div style="margin-top:0.8em;color:#27ae60;">
            <strong>‚úçÔ∏è Context Sentence:</strong> ${word.sentence || '<em>No context sentence available</em>'}
          </div>
        </div>`
      ).join('');
    }

    function renderQuiz() {
      const list = W();
      if (!list.length) return `<p>Load a Week/Day first.</p>`;
      const due = (typeof dueWordsInCurrentSet === 'function') ? dueWordsInCurrentSet() : [];
      const pool = due.length ? due : list;
      const q = pool[Math.floor(Math.random() * pool.length)];
      const inputId = "quiz-answer";
      return `
        <p><strong>What is the definition of "<span>${q.word}</span>"?</strong></p>
        <input type="text" id="${inputId}" style="width:100%;padding:8px;" placeholder="Type your answer here...">
        <button onclick="checkAnswer('${escapeJS(q.word)}','${escapeJS(q.definition)}','${inputId}')">Check</button>
        <p id="quiz-feedback" style="margin-top:10px;"></p>
        <p style="margin-top:10px;color:#555;">${due.length ? 'üîÅ Spaced practice word' : 'üìö Practice word'}</p>
      `;
    }

    function renderStoryBuilder() {
      const list = W();
      if (!list.length) return `<p>No words loaded yet. Use the Week/Day picker and press <strong>Load</strong>.</p>`;
      
      // Show story builder prompts from CSV data
      return list.map(word => {
        if (word.storyBuilder && word.storyBuilder.trim()) {
          return `<div style="margin-bottom:1.5em;padding:1em;background-color:#fff8dc;border-radius:8px;border-left:4px solid #f39c12;">
            <strong style="color:#2c3e50;font-size:1.1em;">${word.word}</strong>
            <span style="color:#7f8c8d;margin-left:0.5em;">(${word.partOfSpeech || 'unknown'})</span>
            <div style="margin-top:0.5em;color:#34495e;">
              <strong>Definition:</strong> ${word.definition}
            </div>
            <div style="margin-top:0.8em;color:#d68910;">
              <strong>üß© Story Prompt:</strong> ${word.storyBuilder}
            </div>
          </div>`;
        }
        return '';
      }).filter(item => item).join('') || 
      `<div style="padding:1em;background-color:#fff8dc;border-radius:8px;border-left:4px solid #f39c12;">
        <p><strong>üß© Creative Story Challenge</strong></p>
        <p>Use these words in a creative sentence or story:</p>
        <ul>${shuffle(list).slice(0, 5).map(w => `<li><strong>${w.word}</strong> - ${w.definition}</li>`).join('')}</ul>
        <textarea rows="6" style="width:100%;padding:10px;margin-top:10px;" placeholder="Write your creative story here using the words above..."></textarea>
      </div>`;
    }

    function renderSpacedRecall() {
      if (typeof dueWordsInCurrentSet !== 'function') {
        return `<p>Spaced recall engine not loaded. Make sure <code>scheduler.js</code> is included.</p>`;
      }
      const list = W();
      if (!list.length) return `<p>Load a Week/Day first.</p>`;
      const due = dueWordsInCurrentSet();
      if (!due.length) return "<p>No words are due for spaced review right now. ‚úÖ</p>";

      const items = due.map(w => {
        const distractors = shuffle(W().filter(x => x.word !== w.word)).slice(0,3).map(x => x.definition);
        const choices = shuffle([w.definition, ...distractors]);
        const opts = choices.map(c => `<label style="display:block;margin:.25rem 0;">
            <input type="radio" name="q_${w.word}" value="${escapeHTML(c)}"> ${escapeHTML(c)}
          </label>`).join('');
        return `<div class="rev-item" style="margin:1rem 0;padding:.75rem;border:1px solid #eee;border-radius:8px;">
          <strong>${w.word}</strong>
          <div>${opts}</div>
          <button onclick="gradeReview('${escapeJS(w.word)}','${escapeJS(w.definition)}')">Check</button>
          <span id="res_${cssEscape(w.word)}" style="margin-left:.5rem;"></span>
        </div>`;
      }).join('');

      return `<h3>üîÅ Spaced Review (${due.length} due)</h3>${items}`;
    }

    function checkAnswer(word, correct, inputId) {
      const userInput = document.getElementById(inputId).value.trim().toLowerCase();
      const ok = userInput && correct.toLowerCase().split(/\W+/).some(t => t && userInput.includes(t));
      document.getElementById("quiz-feedback").textContent = ok
        ? "‚úÖ Correct!"
        : `‚ùå Try again. Correct answer: ${correct}`;
      if (typeof updateDueCountBadge === 'function') updateDueCountBadge();
    }

    function gradeReview(word, correctDef) {
      const sel = document.querySelector(`input[name="q_${cssEscape(word)}"]:checked`);
      const res = document.getElementById(`res_${cssEscape(word)}`);
      if (!sel) { if (res) res.textContent = 'Pick an option.'; return; }
      const ok = sel.value === correctDef;
      if (res) res.textContent = ok ? '‚úÖ' : '‚ùå';
      if (typeof updateDueCountBadge === 'function') updateDueCountBadge();
    }

    // Global showTab function
    function showTab(tabName, btn) {
      const tabContent = document.getElementById("tab-content");
      document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
      
      // Find the button that was clicked or matches the tab
      let activeBtn = btn;
      if (!activeBtn) {
        activeBtn = document.querySelector(`.tabs button[data-tab="${tabName}"]`);
      }
      if (activeBtn) activeBtn.classList.add('active');

      // Render the appropriate tab content
      if (tabName === "visual")   tabContent.innerHTML = renderVisualWall();
      if (tabName === "mnemonics")tabContent.innerHTML = renderMnemonics();
      if (tabName === "context")  tabContent.innerHTML = renderContextSentences();
      if (tabName === "quiz")     tabContent.innerHTML = renderQuiz();
      if (tabName === "story")    tabContent.innerHTML = renderStoryBuilder();
      if (tabName === "review")   tabContent.innerHTML = renderSpacedRecall();
    }

    // Auto-load CSV from GitHub (efficient approach - no localStorage storage)
    let cachedFullDataset = null;
    
    async function autoLoadFromGitHub() {
      try {
        document.getElementById('ingestStatus').textContent = 'üì• Loading enhanced dataset from GitHub...';
        
        // Fetch CSV from GitHub repository
        const response = await fetch('data/sesamewords_leveled_list_with_mnemonics.csv');
        if (!response.ok) throw new Error('Failed to fetch data from GitHub');
        
        const csvText = await response.text();
        const parsed = parseCSV(csvText);
        const normalized = normalizeRows(parsed);
        
        if (!normalized.length) {
          document.getElementById('ingestStatus').textContent = '‚ùå No valid data found in GitHub dataset.';
          return;
        }

        // Cache dataset in memory instead of localStorage to avoid quota issues
        cachedFullDataset = normalized;
        
        // Initialize week/day selectors based on dataset size
        initWeekDaySelectorsFromCache();
        document.getElementById('ingestStatus').textContent = 
          `‚úÖ Auto-loaded ${normalized.length} words from GitHub! Ready to learn.`;
        
        // Auto-load Week 1 / Day 1 to show words immediately
        loadWeekDayFromCache(1, 1);
        if (typeof showTab === 'function') showTab('visual');
        
      } catch (error) {
        console.error('Auto-load error:', error);
        document.getElementById('ingestStatus').textContent = 
          '‚ùå Failed to auto-load from GitHub. Try uploading the CSV file manually.';
      }
    }

    // Initialize selectors from cached dataset
    function initWeekDaySelectorsFromCache() {
      if (!cachedFullDataset) return;
      
      const totalWeeks = Math.ceil(cachedFullDataset.length / 100);
      const weekSel = document.getElementById('weekSelect');
      const daySel = document.getElementById('daySelect');
      
      weekSel.innerHTML = '';
      for (let i = 1; i <= totalWeeks; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `Week ${i}`;
        weekSel.appendChild(opt);
      }
      
      daySel.innerHTML = '';
      for (let i = 1; i <= 5; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `Day ${i}`;
        daySel.appendChild(opt);
      }
    }

    // Load specific week/day from cached dataset
    function loadWeekDayFromCache(week, day) {
      if (!cachedFullDataset) {
        console.warn('No cached dataset available');
        return;
      }
      
      const perWeek = 100, perDay = 20;
      const start = (week - 1) * perWeek + (day - 1) * perDay;
      const slice = cachedFullDataset.slice(start, start + perDay);
      
      window.wordList = slice;
      console.log(`Loaded Week ${week}, Day ${day}: ${slice.length} words`);
      
      if (typeof updateDueCountBadge === 'function') updateDueCountBadge();
    }

    // Override the original loadSelectedWeekDay to use cache
    function loadSelectedWeekDayFromCache() {
      const week = parseInt(document.getElementById('weekSelect').value);
      const day = parseInt(document.getElementById('daySelect').value);
      loadWeekDayFromCache(week, day);
      
      // Refresh current tab
      const activeTab = document.querySelector('.tabs button.active');
      if (activeTab) {
        const tabName = activeTab.getAttribute('data-tab');
        if (typeof showTab === 'function') showTab(tabName);
      }
    }

    // Initialize after all scripts are loaded
    document.addEventListener('DOMContentLoaded', () => {
      initWeekDaySelectors();
      document.getElementById('loadWeekBtn').addEventListener('click', () => {
        // Use cache-based loading if available, otherwise fall back to original
        if (cachedFullDataset) {
          loadSelectedWeekDayFromCache();
        } else {
          loadSelectedWeekDay();
        }
      });
      document.getElementById('ingestBtn').addEventListener('click', handleBulkIngest);
      document.getElementById('autoLoadBtn').addEventListener('click', autoLoadFromGitHub);
      document.getElementById('manualLoadToggle').addEventListener('click', () => {
        const uploadDiv = document.getElementById('manualUpload');
        uploadDiv.style.display = uploadDiv.style.display === 'none' ? 'block' : 'none';
      });
      document.getElementById('resetBtn').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete all vocabulary data? This cannot be undone.')) {
          resetAllData();
        }
      });
      updateDueCountBadge();
      
      // Add event listeners to tab buttons
      document.querySelectorAll('.tabs button[data-tab]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const tabName = e.target.getAttribute('data-tab');
          showTab(tabName, e.target);
        });
      });
      
      // default view - show visual tab
      showTab('visual');
    });
  </script>
</body>

</html>
